name: 从github上下载CSV文件转Vless节点 Daily Vless Automation

on:
  schedule:
    # 定时任务：每天北京时间早上6点40自动运行（UTC时间22:40）
    - cron: '40 22 * * *'
  workflow_dispatch:  # 允许手动触发
    inputs:
      reason:
        description: '手动触发原因'
        required: false
        default: '手动执行'

jobs:
  vless-automation:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        persist-credentials: false
    
    - name: 设置Python环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: 运行Vless自动化
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        GITHUB_REPO: DaiZhouHui/CustomNode
        GITHUB_BRANCH: main
        CSV_SOURCE_DIR: f_node
        CSV_FILENAME: results.csv
        OUTPUT_NODE_FILE: AutoNode
        OUTPUT_YAML_FILE: AutoNode.yaml
        UUID: 471a8e64-7b21-4703-b1d1-45a221098459
        HOST: knny.dpdns.org
        SNI: knny.dpdns.org
        FINGERPRINT: chrome
        DEFAULT_PORT: 443
        FORCE_PORT_443: true
        REMARKS_PREFIX: 香港节点-
        CUSTOM_PATH: "/?ed=2048"
        MAX_DAYS_TO_KEEP: 10
        AUTO_DELETE_OLD_NODES: true
        REQUEST_TIMEOUT: 30
        MAX_RETRIES: 3
      run: |
        python main.py
    
    - name: 上传日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: automation-logs
        path: |
          logs/
        retention-days: 7